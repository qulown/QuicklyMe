<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writing Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
            font-size: 2em;
        }

        .setup-screen, .game-screen {
            display: none;
        }

        .setup-screen.active, .game-screen.active {
            display: block;
        }

        .prompt-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.85em;
            color: #718096;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .timer-setup {
            margin-bottom: 30px;
        }

        .timer-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .timer-btn {
            padding: 15px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .timer-btn:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .timer-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .timer-start-option {
            margin-bottom: 20px;
        }

        .radio-option {
            display: block;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-option:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .radio-option input[type="radio"] {
            margin-right: 10px;
        }

        .radio-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        textarea {
            width: 100%;
            min-height: 300px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1em;
            line-height: 1.8;
            resize: vertical;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            background: #f7fafc;
        }

        .feedback-item {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 5px;
        }

        .feedback-item.penalty {
            background: #fed7d7;
            color: #c53030;
        }

        .feedback-item.bonus {
            background: #c6f6d5;
            color: #276749;
        }

        .timer-warning {
            color: #e53e3e;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #4a5568;
        }

        .end-screen {
            display: none;
            text-align: center;
        }

        .end-screen.active {
            display: block;
        }

        .final-score {
            font-size: 4em;
            color: #667eea;
            margin: 30px 0;
            font-weight: bold;
        }

        .instructions {
            background: #edf2f7;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: left;
        }

        .instructions h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .instructions ul {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úçÔ∏è Writing Game</h1>

        <!-- Setup Screen -->
        <div class="setup-screen active">
            <div style="background: #edf2f7; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <div style="font-size: 2em; color: #667eea; font-weight: bold;" id="streakDisplay">0</div>
                        <div style="font-size: 0.9em; color: #718096;">Day Streak üî•</div>
                    </div>
                    <div>
                        <div style="font-size: 2em; color: #667eea; font-weight: bold;" id="totalGamesDisplay">0</div>
                        <div style="font-size: 0.9em; color: #718096;">Games Played</div>
                    </div>
                </div>
            </div>

            <div class="instructions">
                <h3>How to Play:</h3>
                <ul>
                    <li>Write sentences based on a one-word prompt (or freestyle)</li>
                    <li>First 10 sentences = 30 points (nothing if you write fewer than 10)</li>
                    <li>Each sentence after 10 = 3 points</li>
                    <li>Milestone bonuses: 20 sentences = +30 points, 30 sentences = +30 points, etc.</li>
                    <li>Penalties: -2 for word repetition within a sentence, -2 for keyboard mashing</li>
                    <li>Backspace penalty: -1 for every 5 backspaces (disabled if voice input detected)</li>
                    <li>Each sentence must have a subject and predicate (no single words!)</li>
                    <li>Mix typing and voice-to-text as needed - the game adapts</li>
                    <li>Just write! The goal is to show up and write something every day</li>
                </ul>
            </div>

            <div class="timer-setup">
                <label>Choose your time limit:</label>
                <div class="timer-options">
                    <button class="timer-btn" data-minutes="5">5 min</button>
                    <button class="timer-btn" data-minutes="10">10 min</button>
                    <button class="timer-btn" data-minutes="15">15 min</button>
                    <button class="timer-btn" data-minutes="20">20 min</button>
                    <button class="timer-btn" data-minutes="25">25 min</button>
                    <button class="timer-btn selected" data-minutes="30">30 min</button>
                </div>
            </div>

            <div class="timer-start-option">
                <label>When should the timer start?</label>
                <label class="radio-option selected">
                    <input type="radio" name="timer-start" value="immediate" checked>
                    Start immediately when I begin writing
                </label>
                <label class="radio-option">
                    <input type="radio" name="timer-start" value="after-ten">
                    Start after I complete 10 sentences
                </label>
            </div>

            <div class="timer-start-option">
                <label>Do you want a prompt word?</label>
                <label class="radio-option selected">
                    <input type="radio" name="use-prompt" value="yes" checked>
                    Yes, give me a prompt word
                </label>
                <label class="radio-option">
                    <input type="radio" name="use-prompt" value="no">
                    No, I'll write freestyle
                </label>
            </div>

            <button class="btn" onclick="startGame()">Start Game</button>
            
            <button class="btn" onclick="showPreviewExport()" style="background: #718096; margin-top: 10px;">üëÅÔ∏è Preview Export Format</button>
        </div>

        <!-- Game Screen -->
        <div class="game-screen">
            <div class="prompt-display" id="promptDisplay"></div>

            <div class="stats">
                <div class="stat-box">
                    <div class="stat-label">Score</div>
                    <div class="stat-value" id="scoreDisplay">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Sentences</div>
                    <div class="stat-value" id="sentenceCount">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Time Left</div>
                    <div class="stat-value" id="timerDisplay">--:--</div>
                </div>
            </div>

            <div id="voiceIndicator" style="display: none; background: #edf2f7; padding: 10px; border-radius: 10px; margin-bottom: 15px; text-align: center; color: #667eea; font-weight: 600;">
                üé§ Voice-to-text detected
            </div>

            <textarea id="writingArea" placeholder="Start writing your sentences here..."></textarea>

            <div class="feedback" id="feedback"></div>

            <button class="btn" onclick="endGame()">End Game</button>
        </div>

        <!-- End Screen -->
        <div class="end-screen">
            <h2>Game Over!</h2>
            <div class="final-score" id="finalScore">0</div>
            <p style="font-size: 1.2em; margin-bottom: 20px;">
                Total Sentences: <span id="finalSentences">0</span><br>
                Backspaces: <span id="backspaceDisplay">0</span>
            </p>
            
            <div id="wordCloud" style="margin: 30px 0; padding: 20px; background: #f7fafc; border-radius: 10px;"></div>
            
            <div id="reviewText" style="margin: 30px 0; padding: 20px; background: #f7fafc; border-radius: 10px; max-height: 400px; overflow-y: auto;"></div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="downloadAsText()">üì§ Share/Save Text</button>
                <button class="btn" onclick="downloadAsMarkdown()">üì§ Share/Save Markdown</button>
            </div>
            
            <button class="btn" onclick="resetGame()" style="margin-top: 10px;">Play Again</button>
        </div>
    </div>

    <script>
      <script>
  // ======= DOM =======
  const writer = document.getElementById('writer');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const timerDisplay = document.getElementById('timer');
  const sentenceCount = document.getElementById('sentences');
  const backspaceCount = document.getElementById('backspaces');
  const endScreen = document.getElementById('endScreen');
  const finalCount = document.getElementById('finalCount');
  const downloadBtn = document.getElementById('downloadBtn');
  const restartBtn = document.getElementById('restartBtn');

  // ======= State =======
  let running = false;
  let timer = 60;                 // change this later to 60/120/300 via a dropdown
  let timerInterval = null;
  let sentences = 0;
  let backs = 0;

  // ======= Utility: split into candidate sentences =======
  // - Treat ., !, ? as sentence enders
  // - Also treat double newlines as ends (common with voice input)
  // - Keep punctuation so we can analyze content better
  function splitIntoCandidates(text) {
    const cleaned = text.replace(/\r/g, '');
    // Split on end punctuation with lookahead OR on blank-line gaps
    const raw = cleaned
      .split(/(?<=[.!?])\s+|\n{2,}/g)
      .map(s => s.trim())
      .filter(Boolean);
    return raw;
  }

  // ======= Anti-gibberish + validity checks =======
  // Returns true if a sentence should count.
  function isValidSentence(s) {
    // 1) Must be at least TWO words (no single-word ‚Äúsentences‚Äù)
    const words = s.split(/\s+/).filter(Boolean);
    if (words.length < 2) return false;

    // 2) Reject obvious keyboard mashing or repeated same char
    //    e.g., "aaaaaa", "asdfasdf", "xxxxxxxx"
    if (/(.)\1{4,}/i.test(s)) return false;         // 5+ same char in a row
    if (/asdf|qwer|zxcv|hjkl|lmao|omgwtf/gi.test(s)) return false;

    // 3) Reject long consonant clusters with no vowels (basic nonsense guard)
    //    "grtmgkpr" style runs of 6+ without vowels
    if (/\b[^aeiouy\s]{6,}\b/i.test(s)) return false;

    // 4) Penalize excessive repetition of the same short word
    //    If 3+ identical one- or two-letter words in a row, toss it.
    if (/\b(\w{1,2})\b(?:\s+\1\b){2,}/i.test(s)) return false;

    // 5) Very low letter+space ratio? (tons of symbols/numbers)
    const lettersSpaces = (s.match(/[a-z\s]/gi) || []).length;
    if (lettersSpaces / Math.max(1, s.length) < 0.65) return false;

    // 6) Looks like a paste? (unusually large burst at once)
    //    We don't block here; paste is blocked elsewhere. Just in case,
    //    if somehow inserted, we can downrank giant lumps with no punctuation.
    const hasEndPunct = /[.!?]\s*$/.test(s);
    if (s.length > 220 && !hasEndPunct) return false;

    return true;
  }

  // ======= Live sentence counting =======
  function recount() {
    const text = writer.value.trim();
    const candidates = splitIntoCandidates(text);
    const valid = candidates.filter(isValidSentence);
    sentences = valid.length;
    sentenceCount.textContent = sentences;
  }

  // ======= RULE ENFORCEMENT =======

  // 1) No pasting during the round (keyboard shortcuts or mouse)
  writer.addEventListener('paste', (e) => {
    if (running) {
      e.preventDefault();
      alert('No pasting during the game. Write your own words!');
    }
  });
  writer.addEventListener('beforeinput', (e) => {
    if (running && e.inputType === 'insertFromPaste') {
      e.preventDefault();
    }
  });
  writer.addEventListener('keydown', (e) => {
    // Block Ctrl/Cmd+V during game
    if (running && (e.ctrlKey || e.metaKey) && (e.key.toLowerCase() === 'v')) {
      e.preventDefault();
    }
  });

  // 2) No editing (Backspace/Delete do nothing while running)
  writer.addEventListener('keydown', (e) => {
    if (!running) {
      // Don‚Äôt allow typing before start
      e.preventDefault();
      return;
    }
    if (e.key === 'Backspace' || e.key === 'Delete') {
      e.preventDefault();
      backs++;
      backspaceCount.textContent = backs;
    }
  });

  // 3) Recount sentences on each input (typing only)
  writer.addEventListener('input', () => {
    if (!running) return;
    recount();
  });

  // ======= Timer & screen transitions =======
  function startGame() {
    running = true;
    backs = 0;
    backspaceCount.textContent = '0';
    writer.value = '';
    writer.disabled = false;
    writer.focus();

    // Reset counters
    sentences = 0;
    sentenceCount.textContent = '0';

    // Start timer
    timer = 60;                   // later: read from a select menu
    timerDisplay.textContent = String(timer);
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      timer--;
      timerDisplay.textContent = String(timer);
      if (timer <= 0) stopGame();
    }, 1000);

    // Disallow autocomplete/correct
    writer.setAttribute('autocomplete', 'off');
    writer.setAttribute('autocorrect', 'off');
    writer.setAttribute('autocapitalize', 'off');
    writer.setAttribute('spellcheck', 'false');
  }

  function stopGame() {
    running = false;
    clearInterval(timerInterval);

    // Hard stop: freeze the textarea
    writer.disabled = true;

    // Count one last time
    recount();

    document.getElementById('game').style.display = 'none';
    endScreen.style.display = 'block';
    finalCount.textContent = String(sentences);
  }

  // Buttons
  startBtn.onclick = startGame;
  stopBtn.onclick = stopGame;
  restartBtn.onclick = () => window.location.reload();

  // ======= Download at the end =======
  downloadBtn.onclick = () => {
    const blob = new Blob([writer.value], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'quicklyme-writing.txt';
    a.click();
  };
</script>

    </script>
</body>
</html>
