<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Writing Game ‚Ä¢ QuicklyMe</title>
<style>
  :root{
    --bg:#775ada; --bg2:#5f77e1; --card:#ffffff; --ink:#1c1f28;
    --muted:#5d6b8a; --accent:#5c8df6; --good:#1f9d55; --bad:#d93025;
    --chip:#eef3ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--ink);
    background: radial-gradient(1200px 800px at 10% 0%,var(--bg2),var(--bg)) fixed;
  }
  .shell{max-width:820px;margin:40px auto;padding:0 16px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(16,22,58,.18);padding:22px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
  header h1{font-size:28px;margin:0}
  .pillrow{display:flex;gap:16px;flex-wrap:wrap}
  .pill{background:var(--chip);padding:10px 14px;border-radius:999px;font-weight:600;color:#5570c8}
  h2{margin:0 0 10px 0}
  .rules ul{margin:8px 0 0 18px;color:var(--muted)}
  label{font-weight:600}
  select,input[type="text"]{border:1px solid #d8dbe8;border-radius:10px;padding:10px 12px;font-size:16px;width:100%}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  button{appearance:none;border:0;border-radius:10px;background:var(--accent);color:#fff;padding:12px 16px;font-size:16px;font-weight:700;cursor:pointer}
  button.secondary{background:#e7eaf6;color:#2b3a67}
  button.danger{background:var(--bad)}
  button:disabled{opacity:.55;cursor:not-allowed}
  textarea{
    width:100%; min-height:240px; resize:none; padding:14px 16px; font-size:18px; line-height:1.5;
    border:2px solid #e1e5f2; border-radius:12px; outline:none;
  }
  .meta{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0 16px 0}
  .meta .kpi{background:var(--chip);border-radius:12px;padding:8px 12px;font-weight:700;color:#32407a}
  .muted{color:var(--muted)}
  .center{text-align:center}
  .space{height:10px}
  .hidden{display:none !important}
  .good{color:var(--good)} .bad{color:var(--bad)}
  .footnote{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="shell">

  <!-- SETUP -->
  <div id="screen-setup" class="card">
    <header>
      <div style="font-size:26px">‚úçÔ∏è</div>
      <h1>Writing Game</h1>
    </header>

    <div class="pillrow">
      <div class="pill"><span id="streakDays">0</span> Day Streak üî•</div>
      <div class="pill"><span id="gamesPlayed">0</span> Games Played</div>
    </div>

    <div class="space"></div>

    <section class="rules card" style="border:1px dashed #e1e5f2">
      <h2>How to Play</h2>
      <ul>
        <li>Just write. Don‚Äôt edit. Stop when the timer stops.</li>
        <li>No pasting, no AI dumps. Backspace/Delete are disabled during play.</li>
        <li>Sentences must have 2+ words; obvious gibberish won‚Äôt count.</li>
        <li>Export your writing at the end (TXT / Markdown).</li>
      </ul>
    </section>

    <div class="space"></div>

    <div class="row">
      <div>
        <label for="duration">Choose your time limit</label>
        <select id="duration">
          <option value="60">1 minute</option>
          <option value="180">3 minutes</option>
          <option value="300" selected>5 minutes</option>
          <option value="600">10 minutes</option>
        </select>
      </div>
      <div>
        <label for="prompt">Optional one-word prompt</label>
        <input id="prompt" type="text" placeholder="e.g., ladder" />
      </div>
    </div>

    <div class="space"></div>
    <div class="center">
      <button id="btnStart">Start</button>
    </div>
  </div>

  <!-- GAME -->
  <div id="screen-game" class="card hidden">
    <header>
      <div style="font-size:26px">‚åõ</div>
      <h1>Go!</h1>
    </header>

    <div class="meta">
      <div class="kpi">Time: <span id="kTimer">‚Äì</span></div>
      <div class="kpi">Sentences: <span id="kSentences">0</span></div>
      <div class="kpi">Corrections: <span id="kBacks">0</span></div>
    </div>

    <textarea id="writer" placeholder="Type continuously. Backspace and Delete are disabled during play."></textarea>

    <div class="space"></div>
    <div class="row">
      <button id="btnStop" class="danger">Stop</button>
      <button id="btnRules" class="secondary">Rules active: no paste, no edit</button>
    </div>
    <div class="footnote">Tip: paragraphs (blank lines) also end a sentence if you forget punctuation.</div>
  </div>

  <!-- END -->
  <div id="screen-end" class="card hidden">
    <header>
      <div style="font-size:26px">üèÅ</div>
      <h1>Time‚Äôs Up</h1>
    </header>

    <p class="muted">You wrote <b><span id="finalCount">0</span></b> valid sentences.</p>
    <div class="space"></div>

    <div class="row">
      <button id="btnDownloadTxt">Download TXT</button>
      <button id="btnDownloadMd" class="secondary">Download Markdown</button>
    </div>

    <div class="space"></div>
    <div class="center">
      <button id="btnAgain">Play Again</button>
    </div>
  </div>
</div>

<script>
/* ===============================
   Minimal game engine ‚Äî Mandy rules
   =============================== */

const el = (id)=>document.getElementById(id);

// Screens
const scrSetup = el('screen-setup');
const scrGame  = el('screen-game');
const scrEnd   = el('screen-end');

// Setup controls
const selDuration = el('duration');
const inpPrompt   = el('prompt');
const btnStart    = el('btnStart');

// Game controls
const txt         = el('writer');
const btnStop     = el('btnStop');
const btnRules    = el('btnRules');
const kTimer      = el('kTimer');
const kSentences  = el('kSentences');
const kBacks      = el('kBacks');

// End controls
const finalCount  = el('finalCount');
const btnTxt      = el('btnDownloadTxt');
const btnMd       = el('btnDownloadMd');
const btnAgain    = el('btnAgain');

// Streak / stats
const streakDays  = el('streakDays');
const gamesPlayed = el('gamesPlayed');

// State
let state = {
  running:false,
  duration:300,
  remaining:300,
  timerId:null,
  sentences:0,
  backs:0,
  startedAt:null,
  writing:""
};

/* ---------- Utilities ---------- */

// local midnight date key in user's timezone
function localDateKey(d=new Date()){
  return [d.getFullYear(), (d.getMonth()+1).toString().padStart(2,'0'), d.getDate().toString().padStart(2,'0')].join('-');
}

// sentence splitting + filtering
function splitCandidates(text){
  const cleaned = (text||'').replace(/\r/g,'');
  return cleaned
   .split(/(?<=[.!?])\s+|\n{2,}/g)   // end punctuation OR blank line
   .map(s=>s.trim())
   .filter(Boolean);
}

function looksGibberish(s){
  // 5+ same char, asdf/qwer, 6+ consonants no vowels, symbol soup ratio
  if (/(.)\1{4,}/i.test(s)) return true;
  if (/asdf|qwer|zxcv|hjkl/gi.test(s)) return true;
  if (/\b[^aeiouy\s]{6,}\b/i.test(s)) return true;
  const lettersSpaces = (s.match(/[a-z\s]/gi)||[]).length;
  if (lettersSpaces / Math.max(1,s.length) < 0.65) return true;
  return false;
}

function validSentence(s){
  const words = s.split(/\s+/).filter(Boolean);
  if (words.length < 2) return false;         // no single-word sentences
  if (looksGibberish(s)) return false;
  return true;
}

function recount(){
  const candidates = splitCandidates(txt.value.trim());
  const valid = candidates.filter(validSentence);
  state.sentences = valid.length;
  kSentences.textContent = state.sentences;
}

/* ---------- Rules enforcement ---------- */

// block paste (mouse, keys, or programmatic)
txt.addEventListener('paste', (e)=>{ if(state.running){ e.preventDefault(); alert('No pasting during the game.'); }});
txt.addEventListener('beforeinput', (e)=>{
  if(state.running && e.inputType === 'insertFromPaste'){ e.preventDefault(); }
});
txt.addEventListener('keydown', (e)=>{
  if(state.running && (e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='v'){ e.preventDefault(); }
});

// block editing keys during play; count attempts
function onKeyDown(e){
  if(!state.running){ e.preventDefault(); return; }
  if(e.key==='Backspace' || e.key==='Delete'){
    e.preventDefault();
    state.backs++; kBacks.textContent = state.backs;
  }
}
function onInput(){
  if(!state.running) return;
  recount();
}

/* ---------- Timer ---------- */
function tick(){
  state.remaining--;
  kTimer.textContent = state.remaining + 's';
  if(state.remaining<=0) stopGame();
}

/* ---------- Screens ---------- */
function showSetup(){ scrSetup.classList.remove('hidden'); scrGame.classList.add('hidden'); scrEnd.classList.add('hidden'); }
function showGame(){  scrSetup.classList.add('hidden');    scrGame.classList.remove('hidden'); scrEnd.classList.add('hidden'); }
function showEnd(){   scrSetup.classList.add('hidden');    scrGame.classList.add('hidden');    scrEnd.classList.remove('hidden'); }

/* ---------- Start / Stop ---------- */
function startGame(){
  state.duration  = parseInt(selDuration.value,10);
  state.remaining = state.duration;
  state.sentences = 0;
  state.backs     = 0;
  state.running   = true;
  state.startedAt = new Date();

  kTimer.textContent = state.remaining + 's';
  kSentences.textContent = '0';
  kBacks.textContent = '0';

  txt.value = '';
  txt.disabled = false;
  txt.focus();

  // tighten input environment
  txt.setAttribute('autocomplete','off');
  txt.setAttribute('autocorrect','off');
  txt.setAttribute('autocapitalize','off');
  txt.setAttribute('spellcheck','false');

  // listeners
  txt.addEventListener('keydown', onKeyDown);
  txt.addEventListener('input', onInput);

  // if a prompt was given, show it as a non-editable first line hint
  const p = inpPrompt.value.trim();
  if(p) txt.placeholder = `Prompt: ${p}\n\nStart writing‚Ä¶`;
  else  txt.placeholder = 'Start writing‚Ä¶';

  // run
  showGame();
  if(state.timerId) clearInterval(state.timerId);
  state.timerId = setInterval(tick, 1000);
}

function stopGame(){
  if(!state.running) return;
  state.running = false;
  clearInterval(state.timerId);
  txt.disabled = true;
  txt.removeEventListener('keydown', onKeyDown);
  txt.removeEventListener('input', onInput);

  recount(); // final count
  finalCount.textContent = state.sentences.toString();
  state.writing = txt.value;

  // update local stats
  bumpGamesPlayed();
  bumpStreak();

  showEnd();
}

/* ---------- Stats (localStorage) ---------- */
function getLS(key, fallback){ try{ const v = localStorage.getItem(key); return v==null?fallback:JSON.parse(v); }catch{ return fallback; } }
function setLS(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch{} }

function bumpGamesPlayed(){
  const n = getLS('qm_games',0)+1; setLS('qm_games',n);
  gamesPlayed.textContent = n;
}
function bumpStreak(){
  const today = localDateKey();
  const last  = getLS('qm_last','');
  let streak  = getLS('qm_streak',0);

  if(last === today){
    // already counted today
  }else{
    // check if yesterday
    const y = new Date(); y.setDate(y.getDate()-1);
    const yesterday = localDateKey(y);
    if(last === yesterday) streak += 1;
    else streak = 1;
    setLS('qm_last', today);
    setLS('qm_streak', streak);
  }
  streakDays.textContent = getLS('qm_streak',1);
}

function loadStats(){
  gamesPlayed.textContent = getLS('qm_games',0);
  streakDays.textContent  = getLS('qm_streak',0);
}

/* ---------- Exports ---------- */
function download(filename, text, type='text/plain'){
  const blob = new Blob([text], {type});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
}

btnTxt.addEventListener('click', ()=>{
  const header = `Prompt: ${inpPrompt.value.trim()||'-'}\nDate: ${new Date().toLocaleString()}\n\n`;
  download('quicklyme-writing.txt', header + state.writing, 'text/plain');
});
btnMd.addEventListener('click', ()=>{
  const md = [
    `# Writing Game ‚Äî ${new Date().toLocaleDateString()}`,
    `**Prompt:** ${inpPrompt.value.trim()||'-'}`,
    `**Duration:** ${state.duration/60} min`,
    `**Valid sentences:** ${state.sentences}`,
    '',
    state.writing
  ].join('\n');
  download('quicklyme-writing.md', md, 'text/markdown');
});

/* ---------- Wire up ---------- */
btnStart.addEventListener('click', startGame);
btnStop.addEventListener('click', stopGame);
btnAgain.addEventListener('click', ()=>{ showSetup(); txt.disabled=false; txt.value=''; });

btnRules.addEventListener('click', ()=>alert(
  'Rules active during play:\n‚Ä¢ Backspace/Delete disabled\n‚Ä¢ Pasting blocked\n‚Ä¢ Only 2+ word sentences count\n‚Ä¢ Obvious gibberish is ignored'
));

loadStats();  // initialize streak + games
showSetup();  // start screen
</script>
</body>
</html>
